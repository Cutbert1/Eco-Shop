{% extends "base.html" %}
{% load static %}
 
{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col-12 text-center">
                <hr>
                <h3 class="text-center mb-4 fw-bold">Product Management</h3>
                <h5 class="text-muted">Update a Product</h5>
                <hr>
            </div>
        </div>
    </div>
{% endblock %}
 
{% block content %}
    <div class="overlay"></div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-center mb-4 text-muted">Product Inverntory</h6>
                        <form method="POST" action="{% url 'update_product' product.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ form|crispy }}
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <a class="btn btn-outline-dark rounded-0" href="{% url 'products' %}">Cancel</a>
                                <button class="btn btn-dark rounded-0" type="submit">Update Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    <script type="text/javascript">
        $('#new-image').change(function() {
            var file = $('#new-image')[0].files[0];
            $('#filename').text(`Set image to: ${file.name}`);
        });

        // Validation for price and rating fields
        document.addEventListener('DOMContentLoaded', function() {
            const priceField = document.getElementById('id_price');
            const ratingField = document.getElementById('id_rating');
            const form = document.querySelector('form');

            // Price field validation
            if (priceField) {
                priceField.addEventListener('input', function(e) {
                    const value = parseFloat(e.target.value);
                    
                    if (e.target.value && (!isNaN(value))) {
                        if (value <= 0) {
                            e.target.classList.add('is-invalid');
                            e.target.classList.remove('is-valid');
                            showFieldError(e.target, 'Price must be greater than 0');
                        } else {
                            e.target.classList.add('is-valid');
                            e.target.classList.remove('is-invalid');
                            hideFieldError(e.target);
                        }
                    } else if (e.target.value === '') {
                        e.target.classList.remove('is-invalid', 'is-valid');
                        hideFieldError(e.target);
                    }
                });
            }

            // Rating field validation  
            if (ratingField) {
                ratingField.addEventListener('input', function(e) {
                    const value = parseFloat(e.target.value);
                    
                    if (e.target.value && (!isNaN(value))) {
                        if (value < 0) {
                            e.target.classList.add('is-invalid');
                            e.target.classList.remove('is-valid');
                            showFieldError(e.target, 'Rating must be 0 or greater');
                        } else if (value > 10) {
                            e.target.classList.add('is-invalid');
                            e.target.classList.remove('is-valid');
                            showFieldError(e.target, 'Rating cannot exceed 10');
                        } else {
                            e.target.classList.add('is-valid');
                            e.target.classList.remove('is-invalid');
                            hideFieldError(e.target);
                        }
                    } else if (e.target.value === '') {
                        e.target.classList.remove('is-invalid', 'is-valid');
                        hideFieldError(e.target);
                    }
                });
            }

            // Form submission validation
            if (form) {
                form.addEventListener('submit', function(e) {
                    let hasErrors = false;

                    // Validate price
                    if (priceField && priceField.value) {
                        const priceValue = parseFloat(priceField.value);
                        if (isNaN(priceValue) || priceValue <= 0) {
                            priceField.classList.add('is-invalid');
                            showFieldError(priceField, 'Please enter a valid positive price');
                            hasErrors = true;
                        }
                    }

                    // Validate rating
                    if (ratingField && ratingField.value) {
                        const ratingValue = parseFloat(ratingField.value);
                        if (isNaN(ratingValue) || ratingValue < 0 || ratingValue > 10) {
                            ratingField.classList.add('is-invalid');
                            showFieldError(ratingField, 'Please enter a valid rating between 0-10');
                            hasErrors = true;
                        }
                    }

                    if (hasErrors) {
                        e.preventDefault();
                        return false;
                    }
                });
            }

            // Functions for error display
            function showFieldError(field, message) {
                let feedback = field.parentNode.querySelector('.invalid-feedback');
                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    field.parentNode.appendChild(feedback);
                }
                feedback.textContent = message;
                feedback.style.display = 'block';
            }

            function hideFieldError(field) {
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.style.display = 'none';
                }
            }
        });
    </script>
{% endblock %}